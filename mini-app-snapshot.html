<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0c0c0c" />
  <title>PadelSense - Snapshot</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* PadelSense Mini App ‚Äî –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Ç—ë–º–Ω—ã–π –¥–∏–∑–∞–π–Ω */
    :root {
      --bg: #0c0c0c;
      --bg-elevated: #141414;
      --bg-card: #1a1a1a;
      --border: rgba(255, 255, 255, 0.08);
      --text: #fafafa;
      --text-muted: #a3a3a3;
      --accent: #10b981;
      --accent-hover: #059669;
      --gold: #d4af37;
      --pro-badge: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
      --radius: 12px;
      --radius-lg: 16px;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
      --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .header {
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-inner {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
    }

    .nav-tabs {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .tab {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 8px 12px;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab.active {
      background: var(--accent);
      color: #fff;
    }

    .main {
      flex: 1;
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
      width: 100%;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .view-head {
      text-align: center;
      margin-bottom: 32px;
    }

    .view-head h2 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .view-head p {
      color: var(--text-muted);
      font-size: 0.9375rem;
    }

    /* –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
    .register-form {
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #fff;
    }

    .form-group input[type="text"],
    .form-group input[type="tel"],
    .form-group input[type="email"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #334155;
      border-radius: 8px;
      background: #1e293b;
      color: #fff;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .form-group small {
      display: block;
      margin-top: 4px;
      color: #94a3b8;
      font-size: 12px;
    }

    .checkbox-group {
      margin-bottom: 16px;
    }

    .checkbox-label {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      cursor: pointer;
      color: #cbd5e1;
      font-size: 14px;
      line-height: 1.4;
    }

    .checkbox-label input[type="checkbox"] {
      margin-top: 2px;
      min-width: 16px;
      height: 16px;
    }

    .checkbox-label a {
      color: #10b981;
      text-decoration: underline;
    }

    .form-help {
      margin-top: 20px;
      text-align: center;
    }

    .form-help small {
      color: #64748b;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius);
      font-family: var(--font);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s, transform 0.1s;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-block {
      width: 100%;
    }

    .btn-secondary {
      background: #64748b;
      color: #fff;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
    }

    .modal-content {
      background-color: #1e293b;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: #fff;
    }

    .modal-close {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      padding: 20px;
      color: #cbd5e1;
    }

    .modal-body h4 {
      color: #fff;
      margin-top: 16px;
      margin-bottom: 8px;
    }

    .modal-body p {
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #334155;
      text-align: right;
    }

    /* QR –∫–æ–¥ */
    .qr-container {
      text-align: center;
      padding: 20px;
    }

    .qr-canvas {
      display: inline-block;
      padding: 20px;
      background: white;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .qr-hint {
      color: var(--text-muted);
      font-size: 0.9375rem;
    }

    /* –î–µ–±–∞–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
    .debug-info {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      max-width: 300px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="app" class="app">
    <header class="header">
      <div class="header-inner">
        <h1 class="logo">PadelSense</h1>
        <nav class="nav-tabs" role="tablist">
          <button type="button" class="tab" data-view="home" role="tab">–ì–ª–∞–≤–Ω–∞—è</button>
          <button type="button" class="tab active" data-view="register" role="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          <button type="button" class="tab" data-view="qr" role="tab">QR</button>
          <button type="button" class="tab" data-view="matches" role="tab">–ú–∞—Ç—á–∏</button>
          <button type="button" class="tab" data-view="highlights" role="tab">–•–∞–π–ª–∞–π—Ç—ã</button>
        </nav>
      </div>
    </header>

    <main class="main">
      <!-- Register (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è) -->
      <section id="view-register" class="view active" role="tabpanel">
        <div class="view-head">
          <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ PadelSense</h2>
          <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ</p>
        </div>
        
        <form id="register-form" class="register-form">
          <div class="form-group">
            <label for="first-name">–ò–º—è *</label>
            <input type="text" id="first-name" name="first_name" required 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" maxlength="50">
          </div>
          
          <div class="form-group">
            <label for="last-name">–§–∞–º–∏–ª–∏—è *</label>
            <input type="text" id="last-name" name="last_name" required 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é" maxlength="50">
          </div>
          
          <div class="form-group">
            <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
            <input type="tel" id="phone" name="phone" required 
                   placeholder="+7 (999) 123-45-67" pattern="\+7 \([0-9]{3}\) [0-9]{3}-[0-9]{2}-[0-9]{2}">
            <small>–§–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX</small>
          </div>
          
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" 
                   placeholder="email@example.com" maxlength="100">
          </div>
          
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="personal-data" name="personal_data" required>
              <span class="checkmark"></span>
              <span>–Ø —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ <a href="#" onclick="showPersonalDataPolicy(); return false;">–æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a> *</span>
            </label>
          </div>
          
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="marketing" name="marketing">
              <span class="checkmark"></span>
              <span>–Ø —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –æ –º–∞—Ç—á–∞—Ö –∏ –∞–∫—Ü–∏—è—Ö</span>
            </label>
          </div>
          
          <button type="submit" class="btn btn-primary btn-block" id="btn-register-submit">
            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
          </button>
          
          <div class="form-help">
            <small>* –ü–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</small>
          </div>
        </form>
      </section>

      <!-- QR -->
      <section id="view-qr" class="view" role="tabpanel">
        <div class="view-head">
          <h2>–í–∞—à QR-–∫–æ–¥</h2>
          <p>–ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç —ç–∫—Ä–∞–Ω –ø–ª–∞–Ω—à–µ—Ç—É —É –∫–æ—Ä—Ç–∞</p>
        </div>
        
        <div class="qr-container">
          <div id="qr-canvas" class="qr-canvas">
            <!-- QR –∫–æ–¥ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
          </div>
          <p id="qr-hint" class="qr-hint">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </section>

      <!-- Home -->
      <section id="view-home" class="view" role="tabpanel">
        <div class="view-head">
          <h2>–ì–ª–∞–≤–Ω–∞—è</h2>
          <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ PadelSense</p>
        </div>
      </section>

      <!-- Matches -->
      <section id="view-matches" class="view" role="tabpanel">
        <div class="view-head">
          <h2>–ú–∞—Ç—á–∏</h2>
          <p>–ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –∏–≥—Ä</p>
        </div>
      </section>

      <!-- Highlights -->
      <section id="view-highlights" class="view" role="tabpanel">
        <div class="view-head">
          <h2>–•–∞–π–ª–∞–π—Ç—ã</h2>
          <p>–õ—É—á—à–∏–µ –º–æ–º–µ–Ω—Ç—ã</p>
        </div>
      </section>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–∏ -->
    <div id="policy-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>–ü–æ–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h3>
          <button class="modal-close" onclick="closePolicyModal()">&times;</button>
        </div>
        <div class="modal-body">
          <h4>1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</h4>
          <p>–ú—ã —Å–æ–±–∏—Ä–∞–µ–º: –§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω, email, —Ñ–æ—Ç–æ –∏–∑ Telegram, ID Telegram.</p>
          
          <h4>2. –¶–µ–ª–∏ —Å–±–æ—Ä–∞</h4>
          <p>‚Ä¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –∫–æ—Ä—Ç–µ —á–µ—Ä–µ–∑ QR-–∫–æ–¥<br>
             ‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –º–∞—Ç—á–∞—Ö<br>
             ‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞<br>
             ‚Ä¢ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</p>
          
          <h4>3. –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h4>
          <p>–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö –≤ –†–§ –∏ –∑–∞—â–∏—â–µ–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –§–ó-152.</p>
          
          <h4>4. –ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
          <p>–í—ã –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤–æ –Ω–∞: –¥–æ—Å—Ç—É–ø, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö.</p>
          
          <h4>5. –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö</h4>
          <p>–ú—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º –±–µ–∑ –≤–∞—à–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closePolicyModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- –î–µ–±–∞–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="debug-info" id="debug-info">
      <strong>üîç Debug Info:</strong><br>
      <div id="debug-content">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const API_BASE = 'http://localhost:8000';
    const tg = window.Telegram && window.Telegram.WebApp;
    
    // –î–µ–±–∞–≥ —Ñ—É–Ω–∫—Ü–∏—è
    function debug(message) {
      const debugDiv = document.getElementById('debug-content');
      const timestamp = new Date().toLocaleTimeString();
      debugDiv.innerHTML = `[${timestamp}] ${message}<br>` + debugDiv.innerHTML;
      console.log(message);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    debug('–°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
    debug('Telegram WebApp: ' + (tg ? '–î–æ—Å—Ç—É–ø–µ–Ω' : '–ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω'));
    debug('API_BASE: ' + API_BASE);

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
    const views = document.querySelectorAll('.view');
    const tabs = document.querySelectorAll('.tab');

    function showView(viewId) {
      debug('showView called with: ' + viewId);
      views.forEach(function (v) {
        v.classList.toggle('active', v.id === 'view-' + viewId);
      });
      tabs.forEach(function (t) {
        t.classList.toggle('active', t.dataset.view === viewId);
      });
      if (viewId === 'qr') renderQR();
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
    function getCurrentUser() {
      try {
        return JSON.parse(localStorage.getItem('padelsense_user') || 'null');
      } catch (e) {
        debug('–û—à–∏–±–∫–∞ getCurrentUser: ' + e.message);
        return null;
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É
    function showPersonalDataPolicy() {
      debug('–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∏');
      document.getElementById('policy-modal').style.display = 'block';
    }

    function closePolicyModal() {
      debug('–ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∏');
      document.getElementById('policy-modal').style.display = 'none';
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function formatPhone(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length > 0) {
        if (value[0] === '7') value = value.substring(1);
        if (value.length > 0) {
          let formatted = '+7';
          if (value.length > 0) formatted += ' (' + value.substring(0, 3);
          if (value.length > 3) formatted += ') ' + value.substring(3, 6);
          if (value.length > 6) formatted += '-' + value.substring(6, 8);
          if (value.length > 8) formatted += '-' + value.substring(8, 10);
          input.value = formatted;
        }
      }
    }

    // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    async function registerUser() {
      debug('–ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      var form = document.getElementById('register-form');
      var submitBtn = document.getElementById('btn-register-submit');
      
      if (!form) {
        debug('–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
        return;
      }
      
      // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
      if (!form.checkValidity()) {
        debug('–§–æ—Ä–º–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é');
        form.reportValidity();
        return;
      }
      
      var formData = new FormData(form);
      var tgUser = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
      if (!tgUser) {
        debug('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram');
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram');
        return;
      }
      
      debug('–î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –≤–∞–ª–∏–¥–Ω—ã');
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
      var originalText = submitBtn.textContent;
      submitBtn.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
      submitBtn.disabled = true;
      
      try {
        var userData = {
          telegram_id: tgUser.id,
          first_name: formData.get('first_name'),
          last_name: formData.get('last_name'),
          phone: formData.get('phone'),
          email: formData.get('email') || null,
          photo_url: tgUser.photo_url || null,
          marketing_consent: formData.get('marketing') === 'on'
        };
        
        debug('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: ' + JSON.stringify(userData));
        
        var res = await fetch(API_BASE + '/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });
        
        debug('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ' + res.status);
        
        if (res.ok) {
          var result = await res.json();
          localStorage.setItem('padelsense_user', JSON.stringify(result));
          debug('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
          alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ PadelSense!');
          showView('qr');
        } else {
          var err = await res.json();
          debug('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + JSON.stringify(err));
          if (res.status === 409) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Telegram —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.');
            showView('qr');
          } else {
            alert('–û—à–∏–±–∫–∞: ' + (err.detail || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ'));
          }
        }
      } catch (e) {
        debug('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
        alert('–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    // QR-–∫–æ–¥ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    function renderQR() {
      debug('–†–µ–Ω–¥–µ—Ä QR –∫–æ–¥–∞');
      var container = document.getElementById('qr-canvas');
      var hint = document.getElementById('qr-hint');
      if (!container || !hint) return;

      var user = getCurrentUser();
      var telegramId = user ? user.telegram_id : null;
      
      if (!telegramId && tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        telegramId = tg.initDataUnsafe.user.id;
      }
      
      if (!telegramId) {
        hint.textContent = '–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram ‚Äî –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –≤–∞—à QR –¥–ª—è –≤—Ö–æ–¥–∞ –Ω–∞ –∫–æ—Ä—Ç.';
        container.innerHTML = '';
        return;
      }

      container.innerHTML = '';
      var qrValue = 'user:' + telegramId;
      debug('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR: ' + qrValue);
      
      if (typeof QRCode !== 'undefined') {
        new QRCode(container, { text: qrValue, width: 180, height: 180 });
      } else {
        var placeholder = document.createElement('div');
        placeholder.style.cssText = 'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:10px;color:#666;word-break:break-all;padding:8px;';
        placeholder.textContent = 'QR: ' + qrValue;
        container.appendChild(placeholder);
      }
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å
      if (user && user.name) {
        hint.textContent = user.name + ', –ø–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç —ç–∫—Ä–∞–Ω –ø–ª–∞–Ω—à–µ—Ç—É —É –∫–æ—Ä—Ç–∞.';
      } else {
        hint.textContent = '–ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç —ç–∫—Ä–∞–Ω –ø–ª–∞–Ω—à–µ—Ç—É —É –∫–æ—Ä—Ç–∞.';
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('DOMContentLoaded', function() {
      debug('DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      var form = document.getElementById('register-form');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          registerUser();
        });
        debug('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω');
      }
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      var phoneInput = document.getElementById('phone');
      if (phoneInput) {
        phoneInput.addEventListener('input', function() {
          formatPhone(this);
        });
        debug('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω');
      }
      
      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
      tabs.forEach(function (tab) {
        tab.addEventListener('click', function () {
          showView(this.dataset.view);
        });
      });
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      debug('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
      var telegramId = tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id;
      debug('Telegram ID: ' + telegramId);
      
      if (!telegramId) {
        debug('–ù–µ—Ç Telegram ID, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');
        showView('register');
      } else {
        debug('–ï—Å—Ç—å Telegram ID, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');
        showView('qr');
      }
    });

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.showPersonalDataPolicy = showPersonalDataPolicy;
    window.closePolicyModal = closePolicyModal;
  </script>
</body>
</html>
